require('dotenv').config();
const express = require("express");
const cors = require("cors");
const path = require("path");
const serveStatic = require("serve-static");
const bodyParser = require("body-parser");
const ejs = require("ejs");
const session = require("express-session");
const passport = require("passport");
const cookieParser = require("cookie-parser");


const stormRouter = require("./storm/router.js").stormRouter
const dataRouter = require("./data/router.js").dataRouter
const authRouter = require("./auth/router.js").authRouter
process.chdir(__dirname)

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//// App Configuration /////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

let app = express()
app.use(cookieParser());
app.use(cors());
app.use(express.static("public"));
app.set("view engine", "ejs");
app.set('views', path.join(__dirname, '/'));
app.use(bodyParser.urlencoded({ extended: true }));
app.use(session({secret: "This is important.", resave: false, saveUninitialized: false}));
app.use(passport.initialize());
app.use(passport.session());

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//// Rutes /////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// app.use('/icons',serveStatic(__dirname + "/icons"))

app.use('/icon/:icon', (req, res) => {res.sendFile(`${__dirname}/services/icon/${req.params.icon}.png`)})

app.use('/info',serveStatic(__dirname + "/services/info"))

app.use('/tech',serveStatic(__dirname + "/services/tech"))

app.use('/data', dataRouter)

app.use('/storm', stormRouter)

app.use('/auth', authRouter)

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//// Starting Server ///////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

let port = process.env.PORT || process.argv[3] || 3000
app.listen(port)

console.log('server started ' + port)
